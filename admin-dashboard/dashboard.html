<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Shuttle AI Admin</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #4F46E5;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --dark: #1F2937;
            --gray: #6B7280;
            --light: #F3F4F6;
            --white: #FFFFFF;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, sans-serif;
            background: var(--light);
            color: var(--dark);
        }
        
        /* Layout */
        .app { display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #1F2937 0%, #374151 100%);
            color: white;
            position: fixed;
            height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 24px;
        }
        .sidebar-logo span { font-size: 36px; }
        .sidebar-logo h2 { font-size: 20px; }
        .sidebar-logo p { font-size: 12px; opacity: 0.7; }
        
        .nav-menu { flex: 1; }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-item span:first-child { font-size: 20px; width: 24px; }
        
        .logout-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            cursor: pointer;
            margin-top: auto;
        }
        .logout-btn:hover { background: #DC2626; }
        
        /* Main */
        .main {
            flex: 1;
            margin-left: 260px;
            min-height: 100vh;
        }
        
        /* Topbar */
        .topbar {
            background: white;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #E5E7EB;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .topbar h1 { font-size: 24px; color: var(--dark); }
        .topbar-right { display: flex; align-items: center; gap: 16px; }
        .live-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #D1FAE5;
            color: #065F46;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .live-dot {
            width: 8px;
            height: 8px;
            background: #10B981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .refresh-btn {
            padding: 10px 16px;
            background: var(--light);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        .refresh-btn:hover { background: #E5E7EB; }
        .admin-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--light);
            border-radius: 24px;
        }
        
        /* Content */
        .content { padding: 24px; }
        
        /* Pages */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .stat-icon.blue { background: rgba(79,70,229,0.1); }
        .stat-icon.green { background: rgba(16,185,129,0.1); }
        .stat-icon.purple { background: rgba(139,92,246,0.1); }
        .stat-icon.orange { background: rgba(245,158,11,0.1); }
        .stat-icon.pink { background: rgba(236,72,153,0.1); }
        .stat-icon.teal { background: rgba(20,184,166,0.1); }
        .stat-info h3 { font-size: 28px; font-weight: 700; }
        .stat-info p { font-size: 14px; color: var(--gray); margin-top: 4px; }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-header h3 { font-size: 16px; }
        .card-body { padding: 24px; }
        
        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }
        .chart-container { height: 280px; }
        
        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px 20px; text-align: left; border-bottom: 1px solid #E5E7EB; }
        th { background: var(--light); font-size: 12px; text-transform: uppercase; color: var(--gray); font-weight: 600; }
        td { font-size: 14px; }
        tr:hover td { background: #F9FAFB; }
        
        /* Status Badges */
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-pending { background: #FEF3C7; color: #92400E; }
        .badge-accepted { background: #DBEAFE; color: #1E40AF; }
        .badge-arriving { background: #E9D5FF; color: #6B21A8; }
        .badge-in_progress { background: #D1FAE5; color: #065F46; }
        .badge-completed { background: #E5E7EB; color: #374151; }
        .badge-cancelled { background: #FEE2E2; color: #991B1B; }
        .badge-available { background: #D1FAE5; color: #065F46; }
        .badge-offline { background: #E5E7EB; color: #374151; }
        .badge-busy { background: #FEF3C7; color: #92400E; }
        .badge-in_transit { background: #DBEAFE; color: #1E40AF; }
        
        /* Grid Cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        .item-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .item-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .item-info { display: flex; align-items: center; gap: 12px; }
        .item-info span { font-size: 32px; }
        .item-info h4 { font-size: 16px; }
        .item-info p { font-size: 13px; color: var(--gray); }
        .item-stats {
            display: flex;
            gap: 20px;
            padding-top: 16px;
            border-top: 1px solid #E5E7EB;
        }
        .item-stat { text-align: center; }
        .item-stat strong { display: block; font-size: 18px; color: var(--primary); }
        .item-stat span { font-size: 12px; color: var(--gray); }
        
        /* Page Header */
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }
        .page-header h2 { font-size: 20px; }
        .count-badge {
            padding: 6px 14px;
            background: var(--primary);
            color: white;
            border-radius: 20px;
            font-size: 13px;
        }
        
        /* Map */
        #mapContainer { height: 600px; border-radius: 16px; overflow: hidden; }
        
        /* AI Cards */
        .ai-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        .ai-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
        }
        .ai-card h3 { margin-bottom: 16px; font-size: 16px; }
        .ai-big { text-align: center; padding: 20px 0; }
        .ai-big strong { display: block; font-size: 48px; color: var(--primary); }
        .ai-big span { color: var(--gray); }
        .ai-list { display: flex; flex-direction: column; gap: 10px; }
        .ai-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--light);
            border-radius: 10px;
        }
        .ai-rank {
            width: 28px;
            height: 28px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
        }
        .ai-list-item .name { flex: 1; font-weight: 500; }
        .ai-list-item .value { color: var(--primary); font-weight: 600; }
        .peak-alert {
            padding: 20px;
            background: var(--light);
            border-radius: 12px;
            text-align: center;
        }
        .peak-alert.active {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
        }
        .peak-alert p { margin: 8px 0; }
        
        /* Filters */
        .filters { display: flex; gap: 12px; }
        .filters select, .filters input {
            padding: 10px 14px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-size: 14px;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .charts-grid, .ai-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .sidebar { width: 70px; padding: 10px; }
            .sidebar-logo h2, .sidebar-logo p, .nav-item span:last-child { display: none; }
            .main { margin-left: 70px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <span>üöê</span>
                <div>
                    <h2>Shuttle AI</h2>
                    <p>Admin Panel</p>
                </div>
            </div>
            
            <nav class="nav-menu">
                <div class="nav-item active" data-page="dashboard">
                    <span>üìä</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" data-page="rides">
                    <span>üöó</span>
                    <span>All Rides</span>
                </div>
                <div class="nav-item" data-page="vehicles">
                    <span>üöê</span>
                    <span>Vehicles</span>
                </div>
                <div class="nav-item" data-page="drivers">
                    <span>üë§</span>
                    <span>Drivers</span>
                </div>
                <div class="nav-item" data-page="passengers">
                    <span>üë•</span>
                    <span>Passengers</span>
                </div>
                <div class="nav-item" data-page="locations">
                    <span>üìç</span>
                    <span>Locations</span>
                </div>
                <div class="nav-item" data-page="map">
                    <span>üó∫Ô∏è</span>
                    <span>Live Map</span>
                </div>
                <div class="nav-item" data-page="analytics">
                    <span>üìà</span>
                    <span>Analytics</span>
                </div>
                <div class="nav-item" data-page="ai">
                    <span>ü§ñ</span>
                    <span>AI Insights</span>
                </div>
            </nav>
            
            <button class="logout-btn" id="logoutBtn">
                <span>üö™</span>
                <span>Logout</span>
            </button>
        </aside>
        
        <!-- Main Content -->
        <main class="main">
            <!-- Top Bar -->
            <header class="topbar">
                <h1 id="pageTitle">Dashboard</h1>
                <div class="topbar-right">
                    <div class="live-badge">
                        <span class="live-dot"></span>
                        Live
                    </div>
                    <button class="refresh-btn" id="refreshBtn">üîÑ Refresh</button>
                    <div class="admin-badge">
                        <span>üë®‚Äçüíº</span>
                        <span id="adminName">Admin</span>
                    </div>
                </div>
            </header>
            
            <!-- Content -->
            <div class="content">
                <!-- Dashboard Page -->
                <div class="page active" id="page-dashboard">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon blue">üöó</div>
                            <div class="stat-info">
                                <h3 id="stat-active">0</h3>
                                <p>Active Rides</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon green">üöê</div>
                            <div class="stat-info">
                                <h3 id="stat-vehicles">0</h3>
                                <p>Available Vehicles</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon purple">üë•</div>
                            <div class="stat-info">
                                <h3 id="stat-passengers">0</h3>
                                <p>Total Passengers</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon orange">‚è±Ô∏è</div>
                            <div class="stat-info">
                                <h3 id="stat-wait">3.2 min</h3>
                                <p>Avg Wait Time</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon teal">‚úÖ</div>
                            <div class="stat-info">
                                <h3 id="stat-today">0</h3>
                                <p>Today's Rides</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon pink">üìà</div>
                            <div class="stat-info">
                                <h3 id="stat-rate">98%</h3>
                                <p>Completion Rate</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="charts-grid">
                        <div class="card">
                            <div class="card-header">
                                <h3>üìä Rides Today (Hourly)</h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="hourlyChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3>üöê Vehicle Status</h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="vehicleChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>üïê Recent Rides</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Passenger</th>
                                        <th>Driver</th>
                                        <th>From</th>
                                        <th>To</th>
                                        <th>Status</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="recentRidesTable">
                                    <tr><td colspan="7" class="loading">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Rides Page -->
                <div class="page" id="page-rides">
                    <div class="page-header">
                        <h2>All Rides</h2>
                        <div class="filters">
                            <select id="filterStatus">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="accepted">Accepted</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    <div class="card">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Passenger</th>
                                        <th>Driver</th>
                                        <th>Vehicle</th>
                                        <th>From</th>
                                        <th>To</th>
                                        <th>Distance</th>
                                        <th>Status</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="allRidesTable">
                                    <tr><td colspan="9" class="loading">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Vehicles Page -->
                <div class="page" id="page-vehicles">
                    <div class="page-header">
                        <h2>Fleet Management</h2>
                        <span class="count-badge" id="vehicleCount">0 vehicles</span>
                    </div>
                    <div class="cards-grid" id="vehiclesGrid">
                        <div class="loading">Loading vehicles...</div>
                    </div>
                </div>
                
                <!-- Drivers Page -->
                <div class="page" id="page-drivers">
                    <div class="page-header">
                        <h2>Driver Management</h2>
                        <span class="count-badge" id="driverCount">0 drivers</span>
                    </div>
                    <div class="card">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Vehicle</th>
                                        <th>Status</th>
                                        <th>Rides</th>
                                        <th>Rating</th>
                                    </tr>
                                </thead>
                                <tbody id="driversTable">
                                    <tr><td colspan="7" class="loading">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Passengers Page -->
                <div class="page" id="page-passengers">
                    <div class="page-header">
                        <h2>Registered Passengers</h2>
                        <span class="count-badge" id="passengerCount">0 passengers</span>
                    </div>
                    <div class="card">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Joined</th>
                                    </tr>
                                </thead>
                                <tbody id="passengersTable">
                                    <tr><td colspan="4" class="loading">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Locations Page -->
                <div class="page" id="page-locations">
                    <div class="page-header">
                        <h2>Campus Locations</h2>
                        <span class="count-badge" id="locationCount">0 locations</span>
                    </div>
                    <div class="cards-grid" id="locationsGrid">
                        <div class="loading">Loading locations...</div>
                    </div>
                </div>
                
                <!-- Map Page -->
                <div class="page" id="page-map">
                    <div class="page-header">
                        <h2>Live Vehicle Tracking</h2>
                    </div>
                    <div id="mapContainer"></div>
                </div>
                
                <!-- Analytics Page -->
                <div class="page" id="page-analytics">
                    <div class="page-header">
                        <h2>Analytics & Reports</h2>
                    </div>
                    <div class="charts-grid">
                        <div class="card" style="grid-column: span 2;">
                            <div class="card-header">
                                <h3>üìà Weekly Ride Trends</h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="weeklyChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3>‚è∞ Peak Hours</h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="peakChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3>üìç Popular Locations</h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="locationsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AI Page -->
                <div class="page" id="page-ai">
                    <div class="page-header">
                        <h2>ü§ñ AI Insights & Predictions</h2>
                    </div>
                    <div class="ai-grid">
                        <div class="ai-card">
                            <h3>üìà Demand Prediction</h3>
                            <div class="ai-big">
                                <strong id="aiDemand">15</strong>
                                <span>rides expected next hour</span>
                            </div>
                            <canvas id="demandChart" height="150"></canvas>
                        </div>
                        <div class="ai-card">
                            <h3>‚ö° Peak Hour Status</h3>
                            <div class="peak-alert" id="peakAlert">
                                <p><strong>Next Peak: 4:00 PM</strong></p>
                                <p>Prepare 12 vehicles</p>
                            </div>
                        </div>
                        <div class="ai-card">
                            <h3>üî• Hotspot Locations</h3>
                            <div class="ai-list" id="hotspotList">
                                <div class="ai-list-item">
                                    <span class="ai-rank">1</span>
                                    <span class="name">üìç Library</span>
                                    <span class="value">85 rides</span>
                                </div>
                            </div>
                        </div>
                        <div class="ai-card">
                            <h3>üöê Position Recommendations</h3>
                            <div class="ai-list" id="positionList">
                                <div class="ai-list-item">
                                    <span>üöê Shuttle 01</span>
                                    <span>‚Üí</span>
                                    <span class="value">üìç Library</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ========== SUPABASE SETUP ==========
        const SUPABASE_URL = 'https://gmwqcbqrhxnulrppngdf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdtd3FjYnFyaHhudWxycHBuZ2RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NTgzMjMsImV4cCI6MjA4MzEzNDMyM30.2kX8oxzPPsSilNrQ4TyhE2WiZ3fBZrB8lqVUoyuB0dA';
        
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // ========== GLOBALS ==========
        let currentPage = 'dashboard';
        let leafletMap = null;
        let allCharts = {};
        
        // ========== AUTH CHECK ==========
        const adminData = localStorage.getItem('shuttle_admin');
        if (!adminData) {
            window.location.href = 'login.html';
        }
        const admin = JSON.parse(adminData);
        document.getElementById('adminName').textContent = admin.full_name || 'Admin';
        
        // ========== NAVIGATION ==========
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;
                
                // Update nav
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                
                // Update pages
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('page-' + page).classList.add('active');
                
                // Update title
                const titles = {
                    dashboard: 'Dashboard',
                    rides: 'All Rides',
                    vehicles: 'Fleet Management',
                    drivers: 'Driver Management',
                    passengers: 'Registered Passengers',
                    locations: 'Campus Locations',
                    map: 'Live Vehicle Tracking',
                    analytics: 'Analytics & Reports',
                    ai: 'AI Insights'
                };
                document.getElementById('pageTitle').textContent = titles[page];
                
                currentPage = page;
                loadPageData(page);
            });
        });
        
        // ========== LOGOUT ==========
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('Logout from dashboard?')) {
                localStorage.removeItem('shuttle_admin');
                window.location.href = 'login.html';
            }
        });
        
        // ========== REFRESH ==========
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadPageData(currentPage);
        });
        
        // ========== FILTER ==========
        document.getElementById('filterStatus').addEventListener('change', () => {
            loadAllRides();
        });
        
        // ========== LOAD PAGE DATA ==========
        async function loadPageData(page) {
            switch(page) {
                case 'dashboard': await loadDashboard(); break;
                case 'rides': await loadAllRides(); break;
                case 'vehicles': await loadVehicles(); break;
                case 'drivers': await loadDrivers(); break;
                case 'passengers': await loadPassengers(); break;
                case 'locations': await loadLocations(); break;
                case 'map': initMap(); break;
                case 'analytics': await loadAnalytics(); break;
                case 'ai': await loadAI(); break;
            }
        }
        
        // ========== DASHBOARD ==========
        async function loadDashboard() {
            await loadStats();
            await loadRecentRides();
            loadDashboardCharts();
        }
        
        async function loadStats() {
            try {
                // Active rides
                const { count: active } = await db.from('rides').select('*', { count: 'exact', head: true })
                    .in('status', ['pending', 'accepted', 'arriving', 'in_progress']);
                document.getElementById('stat-active').textContent = active || 0;
                
                // Available vehicles
                const { count: vehicles } = await db.from('vehicles').select('*', { count: 'exact', head: true })
                    .eq('status', 'available');
                document.getElementById('stat-vehicles').textContent = vehicles || 0;
                
                // Total passengers
                const { count: passengers } = await db.from('users').select('*', { count: 'exact', head: true })
                    .eq('role', 'passenger');
                document.getElementById('stat-passengers').textContent = passengers || 0;
                
                // Today's rides
                const today = new Date().toISOString().split('T')[0];
                const { count: todayRides } = await db.from('rides').select('*', { count: 'exact', head: true })
                    .gte('created_at', today);
                document.getElementById('stat-today').textContent = todayRides || 0;
                
                // Completion rate
                const { count: total } = await db.from('rides').select('*', { count: 'exact', head: true });
                const { count: completed } = await db.from('rides').select('*', { count: 'exact', head: true })
                    .eq('status', 'completed');
                const rate = total > 0 ? Math.round((completed / total) * 100) : 98;
                document.getElementById('stat-rate').textContent = rate + '%';
                
            } catch (err) {
                console.error('Stats error:', err);
            }
        }
        
        async function loadRecentRides() {
            try {
                const { data, error } = await db.from('rides')
                    .select('*, passenger:users!rides_passenger_id_fkey(full_name), driver:drivers(user:users(full_name))')
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                const tbody = document.getElementById('recentRidesTable');
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="loading">No rides found. Request a ride from the mobile app!</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(r => `
                    <tr>
                        <td><code>${r.id.slice(0,8)}...</code></td>
                        <td>${r.passenger?.full_name || 'N/A'}</td>
                        <td>${r.driver?.user?.full_name || 'Pending'}</td>
                        <td>${r.pickup_address || 'N/A'}</td>
                        <td>${r.dropoff_address || 'N/A'}</td>
                        <td><span class="badge badge-${r.status}">${r.status}</span></td>
                        <td>${formatTime(r.created_at)}</td>
                    </tr>
                `).join('');
                
            } catch (err) {
                console.error('Recent rides error:', err);
            }
        }
        
        function loadDashboardCharts() {
            // Hourly chart
            const ctx1 = document.getElementById('hourlyChart');
            if (allCharts.hourly) allCharts.hourly.destroy();
            allCharts.hourly = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['6AM', '8AM', '10AM', '12PM', '2PM', '4PM', '6PM', '8PM'],
                    datasets: [{
                        label: 'Rides',
                        data: [8, 25, 18, 32, 22, 35, 45, 15],
                        borderColor: '#4F46E5',
                        backgroundColor: 'rgba(79,70,229,0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
            
            // Vehicle status
            const ctx2 = document.getElementById('vehicleChart');
            if (allCharts.vehicle) allCharts.vehicle.destroy();
            
            db.from('vehicles').select('status').then(({ data }) => {
                const counts = { available: 0, in_transit: 0, offline: 0 };
                (data || []).forEach(v => counts[v.status] = (counts[v.status] || 0) + 1);
                
                allCharts.vehicle = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Available', 'In Transit', 'Offline'],
                        datasets: [{
                            data: [counts.available, counts.in_transit, counts.offline],
                            backgroundColor: ['#10B981', '#4F46E5', '#6B7280']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            });
        }
        
        // ========== ALL RIDES ==========
        async function loadAllRides() {
            const status = document.getElementById('filterStatus').value;
            
            try {
                let query = db.from('rides')
                    .select('*, passenger:users!rides_passenger_id_fkey(full_name), driver:drivers(user:users(full_name)), vehicle:vehicles(vehicle_name)')
                    .order('created_at', { ascending: false })
                    .limit(100);
                
                if (status) query = query.eq('status', status);
                
                const { data, error } = await query;
                if (error) throw error;
                
                const tbody = document.getElementById('allRidesTable');
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="loading">No rides found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(r => `
                    <tr>
                        <td><code>${r.id.slice(0,8)}...</code></td>
                        <td>${r.passenger?.full_name || 'N/A'}</td>
                        <td>${r.driver?.user?.full_name || 'Pending'}</td>
                        <td>${r.vehicle?.vehicle_name || 'N/A'}</td>
                        <td>${r.pickup_address || 'N/A'}</td>
                        <td>${r.dropoff_address || 'N/A'}</td>
                        <td>${r.distance_km ? r.distance_km.toFixed(2) + ' km' : '--'}</td>
                        <td><span class="badge badge-${r.status}">${r.status}</span></td>
                        <td>${formatTime(r.created_at)}</td>
                    </tr>
                `).join('');
                
            } catch (err) {
                console.error('All rides error:', err);
            }
        }
        
        // ========== VEHICLES ==========
        async function loadVehicles() {
            try {
                const { data, error } = await db.from('vehicles').select('*').order('vehicle_name');
                if (error) throw error;
                
                document.getElementById('vehicleCount').textContent = (data?.length || 0) + ' vehicles';
                
                const grid = document.getElementById('vehiclesGrid');
                
                if (!data || data.length === 0) {
                    grid.innerHTML = '<div class="loading">No vehicles found</div>';
                    return;
                }
                
                grid.innerHTML = data.map(v => `
                    <div class="item-card">
                        <div class="item-card-header">
                            <div class="item-info">
                                <span>üöê</span>
                                <div>
                                    <h4>${v.vehicle_name}</h4>
                                    <p>${v.vehicle_number}</p>
                                </div>
                            </div>
                            <span class="badge badge-${v.status}">${v.status}</span>
                        </div>
                        <div class="item-stats">
                            <div class="item-stat">
                                <strong>üë• ${v.capacity}</strong>
                                <span>Capacity</span>
                            </div>
                            <div class="item-stat">
                                <strong>üßç ${v.current_passengers || 0}</strong>
                                <span>Current</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (err) {
                console.error('Vehicles error:', err);
            }
        }
        
        // ========== DRIVERS ==========
        async function loadDrivers() {
            try {
                const { data, error } = await db.from('drivers')
                    .select('*, user:users(full_name, email, phone), vehicle:vehicles(vehicle_name)');
                if (error) throw error;
                
                document.getElementById('driverCount').textContent = (data?.length || 0) + ' drivers';
                
                const tbody = document.getElementById('driversTable');
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="loading">No drivers found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(d => `
                    <tr>
                        <td><strong>${d.user?.full_name || 'N/A'}</strong></td>
                        <td>${d.user?.email || 'N/A'}</td>
                        <td>${d.user?.phone || 'N/A'}</td>
                        <td>${d.vehicle?.vehicle_name || 'Not Assigned'}</td>
                        <td><span class="badge badge-${d.status}">${d.status}</span></td>
                        <td>${d.total_rides || 0}</td>
                        <td>‚≠ê ${(d.rating || 5.0).toFixed(1)}</td>
                    </tr>
                `).join('');
                
            } catch (err) {
                console.error('Drivers error:', err);
            }
        }
        
        // ========== PASSENGERS ==========
        async function loadPassengers() {
            try {
                const { data, error } = await db.from('users').select('*').eq('role', 'passenger').order('created_at', { ascending: false });
                if (error) throw error;
                
                document.getElementById('passengerCount').textContent = (data?.length || 0) + ' passengers';
                
                const tbody = document.getElementById('passengersTable');
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="loading">No passengers found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(p => `
                    <tr>
                        <td><strong>${p.full_name}</strong></td>
                        <td>${p.email}</td>
                        <td>${p.phone || 'N/A'}</td>
                        <td>${formatDate(p.created_at)}</td>
                    </tr>
                `).join('');
                
            } catch (err) {
                console.error('Passengers error:', err);
            }
        }
        
        // ========== LOCATIONS ==========
        async function loadLocations() {
            try {
                const { data, error } = await db.from('campus_locations').select('*').order('name');
                if (error) throw error;
                
                document.getElementById('locationCount').textContent = (data?.length || 0) + ' locations';
                
                const grid = document.getElementById('locationsGrid');
                
                if (!data || data.length === 0) {
                    grid.innerHTML = '<div class="loading">No locations found</div>';
                    return;
                }
                
                const emojis = {
                    academic: 'üè´', residential: 'üè†', administration: 'üèõÔ∏è',
                    food: 'üçΩÔ∏è', health: 'üè•', recreation: '‚öΩ',
                    shuttle_stop: 'üöè', entry_exit: 'üö™', utility: 'üÖøÔ∏è', events: 'üé≠'
                };
                
                grid.innerHTML = data.map(l => `
                    <div class="item-card">
                        <div class="item-card-header">
                            <div class="item-info">
                                <span>${emojis[l.location_type] || 'üìç'}</span>
                                <div>
                                    <h4>${l.name}</h4>
                                    <p>${l.location_type}</p>
                                </div>
                            </div>
                            ${l.is_shuttle_stop ? '<span class="badge badge-available">Shuttle Stop</span>' : ''}
                        </div>
                    </div>
                `).join('');
                
            } catch (err) {
                console.error('Locations error:', err);
            }
        }
        
        // ========== MAP ==========
        async function initMap() {
            if (!leafletMap) {
                leafletMap = L.map('mapContainer').setView([7.8540, 9.7835], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(leafletMap);
            }
            
            setTimeout(() => leafletMap.invalidateSize(), 100);
            
            // Load locations
            const { data: locations } = await db.from('campus_locations').select('*');
            (locations || []).forEach(l => {
                L.marker([l.latitude, l.longitude])
                    .bindPopup(`<b>${l.name}</b><br>${l.location_type}`)
                    .addTo(leafletMap);
            });
            
            // Load vehicles
            const { data: vehicles } = await db.from('vehicles').select('*').not('current_latitude', 'is', null);
            (vehicles || []).forEach(v => {
                const color = v.status === 'available' ? '#10B981' : v.status === 'in_transit' ? '#4F46E5' : '#6B7280';
                const icon = L.divIcon({
                    html: `<div style="background:${color};color:white;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;white-space:nowrap;box-shadow:0 2px 4px rgba(0,0,0,0.2);">üöê ${v.vehicle_name}</div>`,
                    className: ''
                });
                L.marker([v.current_latitude, v.current_longitude], { icon })
                    .bindPopup(`<b>${v.vehicle_name}</b><br>${v.vehicle_number}<br>Status: ${v.status}`)
                    .addTo(leafletMap);
            });
        }
        
        // ========== ANALYTICS ==========
        async function loadAnalytics() {
            // Weekly chart
            const ctx1 = document.getElementById('weeklyChart');
            if (allCharts.weekly) allCharts.weekly.destroy();
            allCharts.weekly = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Rides',
                        data: [45, 52, 48, 61, 55, 25, 18],
                        backgroundColor: '#4F46E5',
                        borderRadius: 8
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
            
            // Peak chart
            const ctx2 = document.getElementById('peakChart');
            if (allCharts.peak) allCharts.peak.destroy();
            allCharts.peak = new Chart(ctx2, {
                type: 'radar',
                data: {
                    labels: ['6AM', '8AM', '10AM', '12PM', '2PM', '4PM', '6PM', '8PM'],
                    datasets: [{
                        label: 'Demand',
                        data: [15, 55, 35, 48, 30, 52, 68, 22],
                        backgroundColor: 'rgba(79,70,229,0.2)',
                        borderColor: '#4F46E5'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
            
            // Locations chart
            const ctx3 = document.getElementById('locationsChart');
            if (allCharts.locations) allCharts.locations.destroy();
            allCharts.locations = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: ['Library', 'Lecture Hall A', 'Cafeteria', 'Hostel A', 'Science Block'],
                    datasets: [{
                        label: 'Pickups',
                        data: [85, 72, 58, 45, 38],
                        backgroundColor: '#10B981',
                        borderRadius: 8
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
            });
        }
        
        // ========== AI INSIGHTS ==========
        async function loadAI() {
            const hour = new Date().getHours();
            const peakHours = [7, 8, 9, 12, 13, 16, 17, 18];
            const isPeak = peakHours.includes(hour);
            const demand = isPeak ? 25 + Math.floor(Math.random() * 15) : 8 + Math.floor(Math.random() * 10);
            
            document.getElementById('aiDemand').textContent = demand;
            
            // Peak alert
            const peakAlert = document.getElementById('peakAlert');
            if (isPeak) {
                peakAlert.className = 'peak-alert active';
                peakAlert.innerHTML = '<p><strong>üî¥ PEAK HOUR NOW!</strong></p><p>High demand - Deploy all vehicles</p>';
            } else {
                const nextPeak = peakHours.find(h => h > hour) || peakHours[0];
                peakAlert.innerHTML = `<p><strong>Next Peak: ${nextPeak}:00</strong></p><p>Prepare 12 vehicles</p>`;
            }
            
            // Hotspots
            const hotspots = [
                { name: 'Library', count: 85 },
                { name: 'Lecture Hall A', count: 72 },
                { name: 'Cafeteria', count: 58 },
                { name: 'Hostel A', count: 45 },
                { name: 'Science Block', count: 38 }
            ];
            document.getElementById('hotspotList').innerHTML = hotspots.map((h, i) => `
                <div class="ai-list-item">
                    <span class="ai-rank">${i + 1}</span>
                    <span class="name">üìç ${h.name}</span>
                    <span class="value">${h.count} rides</span>
                </div>
            `).join('');
            
            // Positioning
            const positions = [
                { vehicle: 'Shuttle 01', location: 'Library' },
                { vehicle: 'Shuttle 02', location: 'Lecture Hall A' },
                { vehicle: 'Shuttle 03', location: 'Main Gate' },
                { vehicle: 'Shuttle 04', location: 'Hostel A' },
                { vehicle: 'Shuttle 05', location: 'Cafeteria' }
            ];
            document.getElementById('positionList').innerHTML = positions.map(p => `
                <div class="ai-list-item">
                    <span>üöê ${p.vehicle}</span>
                    <span style="color:#6B7280;">‚Üí</span>
                    <span class="value">üìç ${p.location}</span>
                </div>
            `).join('');
            
            // Demand chart
            const ctx = document.getElementById('demandChart');
            if (allCharts.demand) allCharts.demand.destroy();
            
            const hours = [];
            const predictions = [];
            for (let i = 0; i < 6; i++) {
                const h = (hour + i) % 24;
                hours.push(h + ':00');
                predictions.push(peakHours.includes(h) ? 25 + Math.random() * 15 : 8 + Math.random() * 10);
            }
            
            allCharts.demand = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Predicted',
                        data: predictions,
                        borderColor: '#4F46E5',
                        backgroundColor: 'rgba(79,70,229,0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }
        
        // ========== HELPERS ==========
        function formatTime(str) {
            if (!str) return '--';
            const d = new Date(str);
            return d.toLocaleString('en-NG', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
        }
        
        function formatDate(str) {
            if (!str) return '--';
            const d = new Date(str);
            return d.toLocaleDateString('en-NG', { day: '2-digit', month: 'short', year: 'numeric' });
        }
        
        // ========== REALTIME ==========
        db.channel('realtime-all')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'rides' }, () => {
                console.log('Ride update!');
                if (currentPage === 'dashboard') loadDashboard();
                if (currentPage === 'rides') loadAllRides();
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'vehicles' }, () => {
                if (currentPage === 'vehicles') loadVehicles();
                if (currentPage === 'dashboard') loadDashboard();
            })
            .subscribe();
        
        // ========== INITIAL LOAD ==========
        loadDashboard();
    </script>
</body>
</html>